What is swarm? 

A server clustering solution that brings together differemt OS or hosts into a single managable unit so that we can ochestrate the lifecycle of our container. 

Divided into Manager Nodes and worker nodes. 

Manager Nodes: They have a database on them called Raft Database. It solves their configuration , and gives them all the information they need to have to be the
authority they need inside the swarm. 

docker swarm init - Initialize swarm  
docker service rm - to remove swarm services 
docker service ls - to see services started

docker service ps psql -used to list the replicas (tasks) of a specific Docker service named "psql" within a Docker Swarm cluster.
When you run docker service ps psql, it will provide a table with detailed information about each replica (task) of the "psql" service, including:

ID: The unique ID of the replica.
NAME: The name of the replica.
IMAGE: The Docker image used for the replica.
NODE: The node where the replica is running.
ERROR: Any error message associated with the replica.
CURRENT STATE: The current state of the replica (e.g., Running, Completed, Shutdown).
ERRORS: The number of times the replica encountered errors.
PORTS: The published ports associated with the replica.





raft is a protocol   

Overlay Multi-Host Networking   

Overlay is a new networking driver. It's for intra communication
--driver overlay 
Optional IPsec (AES) encryption on network creation 
Each service above can be connected to multiple networks. (eg frontend and backend) 

TO TEST 

docker network create --driver overlay mydrupal 
docker network ls 
docker service create --name psql --network mydrupal -e POSTGRES_PASSWORD=mypass postgres
docker service create --name drupal --network mydrupal -p 80:80 drupal 
docker service ls - Do this multiple times after the previous commands to see the power of the VP and Routing mesh power
watch docker service ls -- To constantly run your service commands to see if ther are any differences.  


Docker adds a new layer of abstraction to Swarm called Stacks 
Stacks accepts compose files as their dev=clerative defination for services, networks and volumes  

"docker stack deploy" is used instead of "docker service create" 
stacks manages all those objects for us including overlay network per stack. Adds stack name to the start of their name.  
new "deploy:" key in Compose file. Cant do "build:" 
compose ignores "deploy:", swarm ignores "build:"  

using a stack file example-voting-app-stack.yml , the ffg command will spin up a swarm 
docker stack deploy -c example-voting-app-stack.yml <stack name>  

If you change something in the stack file you can apply the code again and the stack will be updated  


======================== SECRETS STORAGE ================================ 
Swarm Raft DB is encrypted on Disk 
Only stored on Disk on Managed nodes
Default is Managers and Workers "control plane" is TLS + Manual Auth 
Secrets are first stored in Swarm and then assigned to a Service(S) 
Only containers in assigned service can see them.  

They look like files in containers but are actually in-memory fs  
./run/secrets/<secret_name> 
./run/secrets/<secret_alias> 

secrets are stored in the swarm db, it's a "swarm-only" thing. U can't have secrets without Swarm 
Local docker-compose can use file-based secrets, but that's not secure 

======= CREATING A SECRET ========================= 

You can have the secret in a file and then create a secret by pointing to that file. 
Example if a file with my secret is called psql_user.txt you can create a secret file pointing to it with the command: docker secret create psql_user psql_user.txt  

If you want to echo a password in, use te command : echo "myDBpassWORD" | docker secret create psql_pass -   
notice the "-" at the end which is telling it to read from the standard input. 


Creating a secret while spinning up a container 

docker service create --name psql --secret psql_user --secret psql_pass -e POSTGRES_PASSWORD_FILE=/run/secrets/psql_pass -e POSTGRES_USER_FILE=/run/secrets/psql_user postgres 

u can go to the container shell and take a look at the secret. 

To remove the secret, you can use 
docker service update --secret-rm 



 








